# docker-compose.prod.yml - Production Deployment
# For Raspberry Pi CM4S with hardware access

services:
  # Main application container
  amplipi:
    image: ${AMPLIPI_IMAGE:-ghcr.io/brianhealey/amplipi:latest}
    container_name: amplipi
    restart: unless-stopped
    network_mode: host
    devices:
      - /dev/i2c-1:/dev/i2c-1           # I2C hardware access
      - /dev/gpiochip0:/dev/gpiochip0   # GPIO for STM32 reset
      - /dev/snd:/dev/snd               # ALSA devices (loopback)
      - /dev/ttyAMA0:/dev/ttyAMA0       # UART for STM32 address assignment
      - /dev/ttyAMA0:/dev/serial0       # Symlink target for code expecting /dev/serial0
    volumes:
      - amplipi-config:/config
      - amplipi-logs:/logs
      - /var/run/docker.sock:/var/run/docker.sock  # Docker API for update manager
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M
    group_add:
      - "986"  # gpio group (for /dev/gpiochip0)
      - "988"  # i2c group (for /dev/i2c-1)
      - "29"   # audio group (for /dev/snd)
      - "20"   # dialout group (for /dev/ttyAMA0)
      - "984"  # docker group (for /var/run/docker.sock)
    cap_add:
      - NET_BIND_SERVICE  # Allow binding to ports <1024 (port 80)
    environment:
      - CONFIG_DIR=/config
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - HARDWARE_MOCK=${HARDWARE_MOCK:-false}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Display driver (TFT/eInk)
  amplipi-display:
    image: ${DISPLAY_IMAGE:-ghcr.io/brianhealey/amplipi-display:latest}
    container_name: amplipi-display
    restart: unless-stopped
    network_mode: host
    devices:
      - /dev/spidev0.0:/dev/spidev0.0   # SPI for TFT display
      - /dev/gpiochip0:/dev/gpiochip0   # GPIO for display control
    group_add:
      - "986"  # gpio group (for /dev/gpiochip0)
      - "997"  # spi group (for /dev/spidev0.0)
    depends_on:
      amplipi:
        condition: service_healthy
    environment:
      - API_URL=http://localhost/api
      - DISPLAY_TYPE=${DISPLAY_TYPE:-tft}
      - REFRESH_INTERVAL=1000

  # Note: AirPlay2 containers are dynamically managed by the amplipi container
  # They are created/destroyed automatically based on stream configuration
  # See internal/docker package for implementation

  # Optional Streaming Services (enable with --profile streaming)

  # Spotify Connect
  spotify:
    image: ${SPOTIFY_IMAGE:-ghcr.io/brianhealey/amplipi-spotify:latest}
    container_name: amplipi-spotify
    restart: unless-stopped
    network_mode: host
    devices:
      - /dev/snd:/dev/snd
    environment:
      - SPOTIFY_NAME=${SPOTIFY_NAME:-AmpliPi}
      - ALSA_DEVICE=lb4c
      - SPOTIFY_BITRATE=${SPOTIFY_BITRATE:-320}
    profiles:
      - streaming

  # Pandora
  pandora:
    image: ${PANDORA_IMAGE:-ghcr.io/brianhealey/amplipi-pandora:latest}
    container_name: amplipi-pandora
    restart: unless-stopped
    network_mode: host
    devices:
      - /dev/snd:/dev/snd
    volumes:
      - amplipi-config:/config:ro
    environment:
      - ALSA_DEVICE=lb5c
    profiles:
      - streaming

  # LMS Client
  lms:
    image: ${LMS_IMAGE:-ghcr.io/brianhealey/amplipi-lms:latest}
    container_name: amplipi-lms
    restart: unless-stopped
    network_mode: host
    devices:
      - /dev/snd:/dev/snd
    environment:
      - LMS_NAME=${LMS_NAME:-AmpliPi}
      - ALSA_DEVICE=lb6c
    profiles:
      - streaming

  # DLNA Renderer
  dlna:
    image: ${DLNA_IMAGE:-ghcr.io/brianhealey/amplipi-dlna:latest}
    container_name: amplipi-dlna
    restart: unless-stopped
    network_mode: host
    devices:
      - /dev/snd:/dev/snd
    environment:
      - DLNA_NAME=${DLNA_NAME:-AmpliPi}
      - ALSA_DEVICE=lb7c
    profiles:
      - streaming

volumes:
  amplipi-config:
    external: true
  amplipi-logs:
    external: true

networks:
  # Macvlan network for AirPlay2 instances (separate IPs)
  amplipi-macvlan:
    driver: macvlan
    driver_opts:
      parent: ${MACVLAN_PARENT:-eth0}
    ipam:
      driver: default
      config:
        - subnet: ${MACVLAN_SUBNET:-192.168.1.0/24}
          gateway: ${MACVLAN_GATEWAY:-192.168.1.1}
          ip_range: ${MACVLAN_IP_RANGE:-192.168.1.100/30}

  # Internal bridge network for inter-container communication
  amplipi-internal:
    driver: bridge
